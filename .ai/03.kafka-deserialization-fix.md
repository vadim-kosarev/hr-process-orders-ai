# Kafka Deserialization Error Fix

## Problem
При обработке сообщений Kafka возникала ошибка:
```
org.springframework.kafka.support.converter.ConversionException: Failed to convert from JSON
Caused by: com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: 
Unrecognized field "commandType" (class hr.orders.domain.command.CreateOrderCommand), 
not marked as ignorable (3 known properties: "commandId", "issuedAt", "order")
```

## Root Cause Analysis

1. **Jackson Type Info**: `OrderCommand` настроена на использование `@JsonTypeInfo` с `commandType` как свойством для определения типа
2. **Deserialization Issue**: При десериализации Jackson добавляет `commandType` в JSON, но при чтении обратно это поле становится неизвестным
3. **Missing Configuration**: ObjectMapper не был правильно настроен для игнорирования неизвестных свойств

## Solution Implemented

### 1. OrderCommand.java
✅ Добавлена аннотация `@JsonIgnoreProperties(ignoreUnknown = true)` для игнорирования неизвестных полей

### 2. CreateOrderCommand.java
✅ Добавлена `@JsonIgnoreProperties(ignoreUnknown = true)` для:
- `CreateOrderCommand` класса
- Внутреннего класса `OrderData`
- Внутреннего класса `OrderItemData`

### 3. AppConfig.java
✅ **ObjectMapper конфигурация:**
- `DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES` уже был установлен на `false`
- Добавлена явная конфигурация для случаев, когда Jackson должен игнорировать неизвестные поля

✅ **ProducerFactory:**
- Убран `JsonSerializer.ADD_TYPE_INFO_HEADERS` конфиг, который не нужен
- Используется встроенная поддержка типов через Jackson аннотации

## Key Changes Summary

| Класс | Изменение | Причина |
|-------|-----------|---------|
| OrderCommand | `@JsonIgnoreProperties(ignoreUnknown = true)` | Игнорировать commandType при десериализации |
| CreateOrderCommand | `@JsonIgnoreProperties(ignoreUnknown = true)` | Игнорировать дополнительные поля |
| OrderData | `@JsonIgnoreProperties(ignoreUnknown = true)` | Гибкость при десериализации вложенных объектов |
| OrderItemData | `@JsonIgnoreProperties(ignoreUnknown = true)` | Гибкость при десериализации элементов |
| AppConfig | Убрать `ADD_TYPE_INFO_HEADERS` | Полагаться на Jackson аннотации вместо заголовков |

## Impact

✅ Kafka будет корректно десериализовать сообщения  
✅ Система будет более устойчива к изменениям в структуре сообщений  
✅ Типизация сообщений сохраняется через Jackson аннотации  

## Files Modified
1. `src/main/java/hr/orders/domain/command/OrderCommand.java`
2. `src/main/java/hr/orders/domain/command/CreateOrderCommand.java`
3. `src/main/java/hr/orders/config/AppConfig.java`

