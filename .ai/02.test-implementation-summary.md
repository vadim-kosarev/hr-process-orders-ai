# OrderServiceTest Implementation - sendMultipleCommandForCreateSameOrderAfterItIsProcessed

## Overview
Реализован интеграционный тест, который проверяет обработку нескольких команд на создание одного и того же ордера.

## Test Scenario

### Шаг 1: Создание команды на создание ордера
```java
CreateOrderCommand command = TestUtils.createTestOrderCommandWithItems(3);
```
- Создаётся команда с 3 позициями товара
- Используется случайный UUID для orderId

### Шаг 2: Отправка ПЕРВОЙ команды
```java
createOrderCommandKafkaTemplate.send(commandTopic, key, command)
```
- Команда отправляется в Kafka тему `order-commands`
- Используется orderId в качестве ключа для партиционирования

### Шаг 3: Ожидание обработки ПЕРВОЙ команды
```java
await().atMost(Duration.ofSeconds(15))
    .pollInterval(Duration.ofSeconds(1))
    .until(() -> {
        OrderStatus status = orderService.getOrderStatus(OrderID.of(orderId))
            .orElse(OrderStatus.NEW);
        return status.isFinal();
    });
```
- Ждёт max 15 секунд, проверяя статус каждую секунду
- Статус считается финальным, если `status.isFinal()` возвращает true
- После этого проверяет финальный статус

### Шаг 4: Отправка ВТОРОЙ команды для того же ордера
- Повторно отправляет ту же команду с тем же orderId
- Это проверяет поведение системы при получении дублирующихся команд

### Шаг 5: Ожидание обработки ВТОРОЙ команды
- Снова ждёт 15 секунд для достижения финального статуса
- Проверяет финальный статус после второй команды

## Key Features

✅ **Деградация**: Система должна обработать дублирующиеся команды идемпотентно
✅ **Логирование**: Каждый шаг логируется с информацией о статусе и временных меток
✅ **Timeout**: Установлены таймауты для предотвращения зависания тестов
✅ **Verification**: Проверяются статусы после каждой команды

## Expected Behavior

1. После ПЕРВОЙ команды: статус должен стать финальным (READY, CANCELLED или FAILED)
2. После ВТОРОЙ команды: статус должен остаться или измениться в зависимости от логики деградации системы

## Test Execution

Тест использует:
- `@SpringBootTest` - полный контекст приложения
- `@ActiveProfiles("test")` - тестовый профиль
- `awaitility` - асинхронная проверка условий
- Kafka Template - отправка сообщений в Kafka

## Notes

- Таймаут 15 секунд подходит для интеграционного тестирования в Docker
- Интервал проверки 1 секунда даёт хороший баланс между реактивностью и нагрузкой
- Используется `failFast()` для быстрого обнаружения проблем

