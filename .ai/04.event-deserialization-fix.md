# OrderEvent Deserialization Fix

## Problem
При обработке событий из Kafka возникала ошибка:
```
org.springframework.kafka.support.converter.ConversionException: Failed to convert from JSON
Caused by: com.fasterxml.jackson.databind.exc.InvalidDefinitionException: 
Cannot construct instance of `hr.orders.domain.event.OrderEvent` 
(no Creators, like default constructor, exist): abstract types either need to be mapped to concrete types
```

## Root Cause Analysis

1. **Abstract Type**: `OrderEvent` - это абстрактный класс, Jackson не знал как его инстанцировать
2. **Missing Type Info**: Отсутствовала информация о том, какой конкретный тип события нужно десериализовать
3. **No JsonSubTypes**: Не было определено связь между типом события и конкретным классом

## Solution Implemented

### 1. OrderEvent.java (Abstract Base Class)
✅ Добавлена `@JsonTypeInfo` аннотация:
- `use = JsonTypeInfo.Id.NAME` - использовать название типа
- `property = "eventType"` - название свойства в JSON для определения типа
- `include = JsonTypeInfo.As.PROPERTY` - включать тип как отдельное свойство

✅ Добавлена `@JsonSubTypes` с всеми конкретными типами событий:
- `ORDER_CREATED` → OrderCreatedEvent
- `ORDER_PROCESSING_STARTED` → OrderProcessingStartedEvent
- `ORDER_PROCESSING_FAILED` → OrderProcessingFailedEvent
- `ORDER_READY` → OrderReadyEvent
- `ORDER_CANCELLED` → OrderCancelledEvent

✅ Добавлена `@JsonIgnoreProperties(ignoreUnknown = true)` для гибкости

### 2. OrderServiceEvent.java (Intermediate Abstract Class)
✅ Добавлена `@JsonIgnoreProperties(ignoreUnknown = true)` 

### 3. Все конкретные события (Leaf Classes)
✅ Добавлена `@JsonIgnoreProperties(ignoreUnknown = true)` к:
- OrderCreatedEvent
- OrderProcessingStartedEvent
- OrderProcessingFailedEvent
- OrderReadyEvent
- OrderCancelledEvent

### 4. OrderID.java (Value Object)
✅ Добавлена `@JsonIgnoreProperties(ignoreUnknown = true)` для безопасной десериализации

## Example JSON Deserialization Flow

**JSON из Kafka:**
```json
{
  "eventType": "ORDER_CREATED",
  "eventId": "abc123",
  "occurredAt": "2026-02-08T17:11:03.754+03:00",
  "orderId": {"value": "52a1aaa3-5d51-47b5-9784-7c9b79e3ba5e"}
}
```

**Процесс:**
1. Jackson читает `eventType: "ORDER_CREATED"`
2. Использует `@JsonSubTypes` для определения класса → `OrderCreatedEvent`
3. Десериализует в конкретный тип события
4. Игнорирует неизвестные поля благодаря `@JsonIgnoreProperties`

## Files Modified

| Файл | Изменение |
|------|-----------|
| OrderEvent.java | Добавлена @JsonTypeInfo, @JsonSubTypes, @JsonIgnoreProperties |
| OrderServiceEvent.java | Добавлена @JsonIgnoreProperties |
| OrderCreatedEvent.java | Добавлена @JsonIgnoreProperties |
| OrderProcessingStartedEvent.java | Добавлена @JsonIgnoreProperties |
| OrderProcessingFailedEvent.java | Добавлена @JsonIgnoreProperties |
| OrderReadyEvent.java | Добавлена @JsonIgnoreProperties |
| OrderCancelledEvent.java | Добавлена @JsonIgnoreProperties |
| OrderID.java | Добавлена @JsonIgnoreProperties |

## Impact

✅ Kafka события теперь корректно десериализуются  
✅ Jackson знает как обработать абстрактные типы  
✅ Система более гибкая к изменениям в JSON структуре  
✅ Типизация полностью работает через Jackson аннотации  

